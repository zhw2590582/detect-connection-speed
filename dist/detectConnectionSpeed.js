!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).DetectConnectionSpeed=t()}(this,function(){"use strict";var i=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var r=function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(e){i(t,e,r[e])})}return t};var n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function o(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var e=function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e};return function(){function t(e){n(this,t),this.option=r({url:"",loop:!0,time:1e3,detectCallback:function(e){return e}},e),this.transportFactory=this.getStreamFactory(),this.detect()}return e(t,[{key:"supportsXhrResponseType",value:function(e){try{var t=new XMLHttpRequest;return t.responseType=e,t.responseType===e}catch(e){return!1}}},{key:"getStreamFactory",value:function(){if("undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers)return this.fetchRequest;return this.supportsXhrResponseType("moz-chunked-arraybuffer")?this.mozXhrRequest:this.xhrRequest}},{key:"detect",value:function(){this.timer=null,this.result=[],this.detectStartTime=(new Date).getTime(),this.requestUrl=this.option.url+"?time="+this.detectStartTime,this.transportFactory()}},{key:"fetchRequest",value:function(){var t=this;if("function"!=typeof window.fetch)throw new Error("fetch function is not supported in your environment");return this.reader=null,fetch(this.requestUrl).then(function(e){if("function"!=typeof e.body.getReader)throw new Error("response.body.getReader function is not supported in your environment");t.reader=e.body.getReader(),function i(){var o=this,s=(new Date).getTime();this.reader.read().then(function(e){var t=e.done,r=e.value;if(t)return o.summary(),void(o.option.loop&&(o.timer=setTimeout(o.detect.bind(o),o.option.time)));var n=(new Date).getTime();o.calculate(new Uint8Array(r),n-s),i.call(o)}).catch(function(e){throw e})}.call(t)})}},{key:"mozXhrRequest",value:function(){var r=this;this.xhr=new XMLHttpRequest,this.xhr.open("GET",this.requestUrl,!0),this.xhr.responseType="moz-chunked-arraybuffer";var n=null,e=function(){var e=(new Date).getTime(),t=e-n;r.calculate(new Uint8Array(r.xhr.response),t),n=e},t=function(){2===r.xhr.readyState&&(n=(new Date).getTime())},i=function(){r.summary(),r.option.loop&&(r.timer=setTimeout(r.detect.bind(r),r.option.time))},o=function e(){throw e};this.xhr.addEventListener("progress",e),this.xhr.addEventListener("readystatechange",t),this.xhr.addEventListener("loadend",i),this.xhr.addEventListener("error",o),this.xhr.destroy=function(){r.xhr.removeEventListener("progress",e),r.xhr.removeEventListener("readystatechange",t),r.xhr.removeEventListener("loadend",i),r.xhr.removeEventListener("error",o)},this.xhr.send()}},{key:"calculate",value:function(e,t){this.result.push({streamSize:e.byteLength,streamTime:t})}},{key:"summary",value:function(){var e=(new Date).getTime()-this.detectStartTime,t=this.resultSum("streamTime"),r=e-t,n=this.resultSum("streamSize"),i=n/t,o=i/1024;this.option.detectCallback({detectTime:e,downloadTime:t,downloadSize:n,waitingTime:r,speedKbps:i,speedMbps:o})}},{key:"resultSum",value:function(r){return this.result.reduce(function(e,t){return e+t[r]},0)}},{key:"destroy",value:function(){this.option.loop=!1,this.timer&&clearTimeout(this.timer),this.reader&&"function"==typeof this.reader.cancel&&this.reader.cancel(),this.xhr&&"function"==typeof this.xhr.abort&&(this.xhr.abort(),this.xhr.destroy())}}]),t}()});
