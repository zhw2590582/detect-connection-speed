!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).DetectConnectionSpeed=t()}(this,function(){"use strict";var o=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e};var n=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),r.forEach(function(e){o(t,e,n[e])})}return t};var r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var e=function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e};var t=null;function s(e,a,u){return fetch(e).then(function(e){t=e.body.getReader(),function i(){var s=Date.now();t.read().then(function(e){var t=e.done,n=e.value;if(t)u();else{var r=Date.now()-s,o=new Uint8Array(n).byteLength;a(o,r),i()}}).catch(function(e){throw e})}()}),{destroy:function(){t&&t.cancel()}}}var u=null;function a(e,r,t){(u=new XMLHttpRequest).open("GET",e,!0),u.responseType="moz-chunked-arraybuffer";var o=null,n=function(){var e=Date.now(),t=e-o,n=new Uint8Array(u.response).byteLength;r(n,t),o=e},i=function(){2===u.readyState&&(o=Date.now())},s=function(){t()},a=function e(){throw e};return u.addEventListener("progress",n),u.addEventListener("readystatechange",i),u.addEventListener("loadend",s),u.addEventListener("error",a),u.send(),{destroy:function(){u&&(u.abort(),u.removeEventListener("progress",n),u.removeEventListener("readystatechange",i),u.removeEventListener("loadend",s),u.removeEventListener("error",a))}}}function c(){if("undefined"!=typeof Response&&Object.prototype.hasOwnProperty.call(Response.prototype,"body")&&"function"==typeof Headers)return s;if(function(e){try{var t=new XMLHttpRequest;return t.responseType=e,t.responseType===e}catch(e){return!1}}("moz-chunked-arraybuffer"))return a;throw new Error("Your browser does not currently support stream factory")}return function(){function t(e){r(this,t),this.option=n({url:"",loop:!0,detectCallback:function(e){return e}},e),this.loopTimer=null,this.stream=null,this.seconds=[],this.calculateSecond=0,this.streamFactory=c(),this.detectStartTime=Date.now(),this.detect()}return e(t,[{key:"detect",value:function(){this.requestUrl=this.option.url+"?time="+Date.now(),this.stream=this.streamFactory(this.requestUrl,this.updateCallback.bind(this),this.doneCallback.bind(this))}},{key:"updateCallback",value:function(e,t){var n={streamSize:e,streamTime:t},r=Math.ceil((Date.now()-this.detectStartTime)/1e3);this.seconds[r]?this.seconds[r].push(n):(this.calculate(),this.seconds[r]=[n])}},{key:"doneCallback",value:function(){this.option.loop&&(this.stream&&"function"==typeof this.stream.destroy&&this.stream.destroy(),this.detect())}},{key:"calculate",value:function(){var e=this.seconds[this.calculateSecond++]||[],t=this.resultSum(e,"streamTime")||0,n=this.resultSum(e,"streamSize")||0,r=n/t||0,o=r/1024;this.option.detectCallback({downloadTime:t,downloadSize:n,speedKbps:r,speedMbps:o})}},{key:"resultSum",value:function(e,n){return e.reduce(function(e,t){return e+t[n]},0)}},{key:"destroy",value:function(){this.option.loop=!1,this.loopTimer&&clearTimeout(this.loopTimer),this.stream&&"function"==typeof this.stream.destroy&&this.stream.destroy()}}]),t}()});
