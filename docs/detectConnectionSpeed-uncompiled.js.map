{"version":3,"file":"detectConnectionSpeed-uncompiled.js","sources":["../node_modules/@babel/runtime/helpers/defineProperty.js","../node_modules/@babel/runtime/helpers/objectSpread.js","../node_modules/@babel/runtime/helpers/classCallCheck.js","../node_modules/@babel/runtime/helpers/createClass.js","../src/getStreamFactory.js","../src/index.js"],"sourcesContent":["function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","var defineProperty = require(\"./defineProperty\");\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    var ownKeys = Object.keys(source);\n\n    if (typeof Object.getOwnPropertySymbols === 'function') {\n      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(source, sym).enumerable;\n      }));\n    }\n\n    ownKeys.forEach(function (key) {\n      defineProperty(target, key, source[key]);\n    });\n  }\n\n  return target;\n}\n\nmodule.exports = _objectSpread;","function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","function supportsXhrResponseType(type) {\n  try {\n    const tmpXhr = new XMLHttpRequest();\n    tmpXhr.responseType = type;\n    return tmpXhr.responseType === type;\n  } catch (e) {\n    return false;\n  }\n}\n\nlet reader = null;\nfunction fetchRequest(requestUrl, updateCallback, doneCallback) {\n  fetch(requestUrl).then(response => {\n    reader = response.body.getReader();\n    (function read() {\n      const readerStartTime = Date.now();\n      reader\n        .read()\n        .then(({ done, value }) => {\n          if (done) {\n            doneCallback();\n            return;\n          }\n          const readerEndTime = Date.now();\n          const streamTime = readerEndTime - readerStartTime;\n          const streamSize = new Uint8Array(value).byteLength;\n          updateCallback(streamSize, streamTime);\n          read();\n        })\n        .catch(error => {\n          throw error;\n        });\n    })();\n  });\n  return {\n    destroy() {\n      reader && reader.cancel();\n    }\n  };\n}\n\nlet xhr = null;\nfunction mozXhrRequest(requestUrl, updateCallback, doneCallback) {\n  xhr = new XMLHttpRequest();\n  xhr.open('GET', requestUrl, true);\n  xhr.responseType = 'moz-chunked-arraybuffer';\n\n  let readerStartTime = null;\n  const progress = () => {\n    const readerEndTime = Date.now();\n    const streamTime = readerEndTime - readerStartTime;\n    const streamSize = new Uint8Array(xhr.response).byteLength;\n    updateCallback(streamSize, streamTime);\n    readerStartTime = readerEndTime;\n  };\n\n  const readystatechange = () => {\n    if (xhr.readyState === 2) {\n      readerStartTime = Date.now();\n    }\n  };\n\n  const loadend = () => {\n    doneCallback();\n  };\n\n  const error = () => {\n    throw error;\n  };\n\n  xhr.addEventListener('progress', progress);\n  xhr.addEventListener('readystatechange', readystatechange);\n  xhr.addEventListener('loadend', loadend);\n  xhr.addEventListener('error', error);\n  xhr.send();\n  return {\n    destroy() {\n      if (xhr) {\n        xhr.abort();\n        xhr.removeEventListener('progress', progress);\n        xhr.removeEventListener('readystatechange', readystatechange);\n        xhr.removeEventListener('loadend', loadend);\n        xhr.removeEventListener('error', error);\n      }\n    }\n  };\n}\n\nexport default function getStreamFactory() {\n  if (\n    typeof Response !== 'undefined' &&\n    Object.prototype.hasOwnProperty.call(Response.prototype, 'body') &&\n    typeof Headers === 'function'\n  ) {\n    return fetchRequest;\n  }\n\n  const mozChunked = 'moz-chunked-arraybuffer';\n  if (supportsXhrResponseType(mozChunked)) {\n    return mozXhrRequest;\n  }\n\n  throw new Error('Your browser does not currently support stream factory');\n}\n","import getStreamFactory from './getStreamFactory';\n\nexport default class DetectConnectionSpeed {\n  constructor(option) {\n    this.option = {\n      url: '',\n      loop: true,\n      detectCallback: result => result,\n      ...option\n    };\n    this.loopTimer = null;\n    this.stream = null;\n    this.seconds = [];\n    this.calculateSecond = 0;\n    this.streamFactory = getStreamFactory();\n    this.detectStartTime = Date.now();\n    this.detect();\n  }\n\n  detect() {\n    this.requestUrl = this.option.url + '?time=' + Date.now();\n    this.stream = this.streamFactory(\n      this.requestUrl,\n      this.updateCallback.bind(this),\n      this.doneCallback.bind(this)\n    );\n  }\n\n  updateCallback(streamSize, streamTime) {\n    const item = { streamSize, streamTime };\n    const second = Math.ceil((Date.now() - this.detectStartTime) / 1000);\n    if (!this.seconds[second]) {\n      this.calculate();\n      this.seconds[second] = [item];\n    } else {\n      this.seconds[second].push(item);\n    }\n  }\n\n  doneCallback() {\n    if (this.option.loop) {\n      if (this.stream && typeof this.stream.destroy === 'function') {\n        this.stream.destroy();\n      }\n      this.detect();\n    }\n  }\n\n  calculate() {\n    const item = this.seconds[this.calculateSecond++] || [];\n    const downloadTime = this.resultSum(item, 'streamTime') || 0;\n    const downloadSize = this.resultSum(item, 'streamSize') || 0;\n    const speedKbps = downloadSize / downloadTime || 0;\n    const speedMbps = speedKbps / 1024;\n    this.option.detectCallback({\n      downloadTime,\n      downloadSize,\n      speedKbps,\n      speedMbps\n    });\n  }\n\n  resultSum(result, key) {\n    return result.reduce((sum, item) => {\n      return sum + item[key];\n    }, 0);\n  }\n\n  destroy() {\n    this.option.loop = false;\n    if (this.loopTimer) {\n      clearTimeout(this.loopTimer);\n    }\n    if (this.stream && typeof this.stream.destroy === 'function') {\n      this.stream.destroy();\n    }\n  }\n}\n"],"names":["supportsXhrResponseType","type","tmpXhr","XMLHttpRequest","responseType","e","reader","fetchRequest","requestUrl","updateCallback","doneCallback","fetch","then","response","body","getReader","read","readerStartTime","Date","now","done","value","readerEndTime","streamTime","streamSize","Uint8Array","byteLength","error","destroy","cancel","xhr","mozXhrRequest","open","progress","readystatechange","readyState","loadend","addEventListener","send","abort","removeEventListener","getStreamFactory","Response","Object","prototype","hasOwnProperty","call","Headers","mozChunked","Error","DetectConnectionSpeed","option","url","loop","detectCallback","result","loopTimer","stream","seconds","calculateSecond","streamFactory","detectStartTime","detect","bind","item","second","Math","ceil","calculate","push","downloadTime","resultSum","downloadSize","speedKbps","speedMbps","key","reduce","sum","clearTimeout"],"mappings":";;;;;;EAAA,SAAS,eAAe,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,EAAE;IACxC,IAAI,GAAG,IAAI,GAAG,EAAE;MACd,MAAM,CAAC,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE;QAC9B,KAAK,EAAE,KAAK;QACZ,UAAU,EAAE,IAAI;QAChB,YAAY,EAAE,IAAI;QAClB,QAAQ,EAAE,IAAI;OACf,CAAC,CAAC;KACJ,MAAM;MACL,GAAG,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;KAClB;;IAED,OAAO,GAAG,CAAC;GACZ;;EAED,kBAAc,GAAG,eAAe;;ECbhC,SAAS,aAAa,CAAC,MAAM,EAAE;IAC7B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;MACzC,IAAI,MAAM,GAAG,SAAS,CAAC,CAAC,CAAC,IAAI,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;MACtD,IAAI,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;MAElC,IAAI,OAAO,MAAM,CAAC,qBAAqB,KAAK,UAAU,EAAE;QACtD,OAAO,GAAG,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,qBAAqB,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,UAAU,GAAG,EAAE;UAClF,OAAO,MAAM,CAAC,wBAAwB,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,UAAU,CAAC;SAChE,CAAC,CAAC,CAAC;OACL;;MAED,OAAO,CAAC,OAAO,CAAC,UAAU,GAAG,EAAE;QAC7B,cAAc,CAAC,MAAM,EAAE,GAAG,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;OAC1C,CAAC,CAAC;KACJ;;IAED,OAAO,MAAM,CAAC;GACf;;EAED,gBAAc,GAAG,aAAa;;ECrB9B,SAAS,eAAe,CAAC,QAAQ,EAAE,WAAW,EAAE;IAC9C,IAAI,EAAE,QAAQ,YAAY,WAAW,CAAC,EAAE;MACtC,MAAM,IAAI,SAAS,CAAC,mCAAmC,CAAC,CAAC;KAC1D;GACF;;EAED,kBAAc,GAAG,eAAe;;ECNhC,SAAS,iBAAiB,CAAC,MAAM,EAAE,KAAK,EAAE;IACxC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;MACrC,IAAI,UAAU,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;MAC1B,UAAU,CAAC,UAAU,GAAG,UAAU,CAAC,UAAU,IAAI,KAAK,CAAC;MACvD,UAAU,CAAC,YAAY,GAAG,IAAI,CAAC;MAC/B,IAAI,OAAO,IAAI,UAAU,EAAE,UAAU,CAAC,QAAQ,GAAG,IAAI,CAAC;MACtD,MAAM,CAAC,cAAc,CAAC,MAAM,EAAE,UAAU,CAAC,GAAG,EAAE,UAAU,CAAC,CAAC;KAC3D;GACF;;EAED,SAAS,YAAY,CAAC,WAAW,EAAE,UAAU,EAAE,WAAW,EAAE;IAC1D,IAAI,UAAU,EAAE,iBAAiB,CAAC,WAAW,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;IACrE,IAAI,WAAW,EAAE,iBAAiB,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;IAC7D,OAAO,WAAW,CAAC;GACpB;;EAED,eAAc,GAAG,YAAY;;EChB7B,SAASA,uBAAT,CAAiCC,IAAjC,EAAuC;EACrC,MAAI;EACF,QAAMC,MAAM,GAAG,IAAIC,cAAJ,EAAf;EACAD,IAAAA,MAAM,CAACE,YAAP,GAAsBH,IAAtB;EACA,WAAOC,MAAM,CAACE,YAAP,KAAwBH,IAA/B;EACD,GAJD,CAIE,OAAOI,CAAP,EAAU;EACV,WAAO,KAAP;EACD;EACF;;EAED,IAAIC,MAAM,GAAG,IAAb;;EACA,SAASC,YAAT,CAAsBC,UAAtB,EAAkCC,cAAlC,EAAkDC,YAAlD,EAAgE;EAC9DC,EAAAA,KAAK,CAACH,UAAD,CAAL,CAAkBI,IAAlB,CAAuB,UAAAC,QAAQ,EAAI;EACjCP,IAAAA,MAAM,GAAGO,QAAQ,CAACC,IAAT,CAAcC,SAAd,EAAT;;EACA,KAAC,SAASC,IAAT,GAAgB;EACf,UAAMC,eAAe,GAAGC,IAAI,CAACC,GAAL,EAAxB;EACAb,MAAAA,MAAM,CACHU,IADH,GAEGJ,IAFH,CAEQ,gBAAqB;EAAA,YAAlBQ,IAAkB,QAAlBA,IAAkB;EAAA,YAAZC,KAAY,QAAZA,KAAY;;EACzB,YAAID,IAAJ,EAAU;EACRV,UAAAA,YAAY;EACZ;EACD;;EACD,YAAMY,aAAa,GAAGJ,IAAI,CAACC,GAAL,EAAtB;EACA,YAAMI,UAAU,GAAGD,aAAa,GAAGL,eAAnC;EACA,YAAMO,UAAU,GAAG,IAAIC,UAAJ,CAAeJ,KAAf,EAAsBK,UAAzC;EACAjB,QAAAA,cAAc,CAACe,UAAD,EAAaD,UAAb,CAAd;EACAP,QAAAA,IAAI;EACL,OAZH,WAaS,UAAAW,KAAK,EAAI;EACd,cAAMA,KAAN;EACD,OAfH;EAgBD,KAlBD;EAmBD,GArBD;EAsBA,SAAO;EACLC,IAAAA,OADK,qBACK;EACRtB,MAAAA,MAAM,IAAIA,MAAM,CAACuB,MAAP,EAAV;EACD;EAHI,GAAP;EAKD;;EAED,IAAIC,GAAG,GAAG,IAAV;;EACA,SAASC,aAAT,CAAuBvB,UAAvB,EAAmCC,cAAnC,EAAmDC,YAAnD,EAAiE;EAC/DoB,EAAAA,GAAG,GAAG,IAAI3B,cAAJ,EAAN;EACA2B,EAAAA,GAAG,CAACE,IAAJ,CAAS,KAAT,EAAgBxB,UAAhB,EAA4B,IAA5B;EACAsB,EAAAA,GAAG,CAAC1B,YAAJ,GAAmB,yBAAnB;EAEA,MAAIa,eAAe,GAAG,IAAtB;;EACA,MAAMgB,QAAQ,GAAG,SAAXA,QAAW,GAAM;EACrB,QAAMX,aAAa,GAAGJ,IAAI,CAACC,GAAL,EAAtB;EACA,QAAMI,UAAU,GAAGD,aAAa,GAAGL,eAAnC;EACA,QAAMO,UAAU,GAAG,IAAIC,UAAJ,CAAeK,GAAG,CAACjB,QAAnB,EAA6Ba,UAAhD;EACAjB,IAAAA,cAAc,CAACe,UAAD,EAAaD,UAAb,CAAd;EACAN,IAAAA,eAAe,GAAGK,aAAlB;EACD,GAND;;EAQA,MAAMY,gBAAgB,GAAG,SAAnBA,gBAAmB,GAAM;EAC7B,QAAIJ,GAAG,CAACK,UAAJ,KAAmB,CAAvB,EAA0B;EACxBlB,MAAAA,eAAe,GAAGC,IAAI,CAACC,GAAL,EAAlB;EACD;EACF,GAJD;;EAMA,MAAMiB,OAAO,GAAG,SAAVA,OAAU,GAAM;EACpB1B,IAAAA,YAAY;EACb,GAFD;;EAIA,MAAMiB,KAAK,GAAG,SAARA,KAAQ,GAAM;EAClB,UAAMA,KAAN;EACD,GAFD;;EAIAG,EAAAA,GAAG,CAACO,gBAAJ,CAAqB,UAArB,EAAiCJ,QAAjC;EACAH,EAAAA,GAAG,CAACO,gBAAJ,CAAqB,kBAArB,EAAyCH,gBAAzC;EACAJ,EAAAA,GAAG,CAACO,gBAAJ,CAAqB,SAArB,EAAgCD,OAAhC;EACAN,EAAAA,GAAG,CAACO,gBAAJ,CAAqB,OAArB,EAA8BV,KAA9B;EACAG,EAAAA,GAAG,CAACQ,IAAJ;EACA,SAAO;EACLV,IAAAA,OADK,qBACK;EACR,UAAIE,GAAJ,EAAS;EACPA,QAAAA,GAAG,CAACS,KAAJ;EACAT,QAAAA,GAAG,CAACU,mBAAJ,CAAwB,UAAxB,EAAoCP,QAApC;EACAH,QAAAA,GAAG,CAACU,mBAAJ,CAAwB,kBAAxB,EAA4CN,gBAA5C;EACAJ,QAAAA,GAAG,CAACU,mBAAJ,CAAwB,SAAxB,EAAmCJ,OAAnC;EACAN,QAAAA,GAAG,CAACU,mBAAJ,CAAwB,OAAxB,EAAiCb,KAAjC;EACD;EACF;EATI,GAAP;EAWD;;AAED,EAAe,SAASc,gBAAT,GAA4B;EACzC,MACE,OAAOC,QAAP,KAAoB,WAApB,IACAC,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCJ,QAAQ,CAACE,SAA9C,EAAyD,MAAzD,CADA,IAEA,OAAOG,OAAP,KAAmB,UAHrB,EAIE;EACA,WAAOxC,YAAP;EACD;;EAED,MAAMyC,UAAU,GAAG,yBAAnB;;EACA,MAAIhD,uBAAuB,CAACgD,UAAD,CAA3B,EAAyC;EACvC,WAAOjB,aAAP;EACD;;EAED,QAAM,IAAIkB,KAAJ,CAAU,wDAAV,CAAN;EACD;;MCrGoBC;;;EACnB,iCAAYC,MAAZ,EAAoB;EAAA;;EAClB,SAAKA,MAAL;EACEC,MAAAA,GAAG,EAAE,EADP;EAEEC,MAAAA,IAAI,EAAE,IAFR;EAGEC,MAAAA,cAAc,EAAE,wBAAAC,MAAM;EAAA,eAAIA,MAAJ;EAAA;EAHxB,OAIKJ,MAJL;EAMA,SAAKK,SAAL,GAAiB,IAAjB;EACA,SAAKC,MAAL,GAAc,IAAd;EACA,SAAKC,OAAL,GAAe,EAAf;EACA,SAAKC,eAAL,GAAuB,CAAvB;EACA,SAAKC,aAAL,GAAqBnB,gBAAgB,EAArC;EACA,SAAKoB,eAAL,GAAuB3C,IAAI,CAACC,GAAL,EAAvB;EACA,SAAK2C,MAAL;EACD;;;;+BAEQ;EACP,WAAKtD,UAAL,GAAkB,KAAK2C,MAAL,CAAYC,GAAZ,GAAkB,QAAlB,GAA6BlC,IAAI,CAACC,GAAL,EAA/C;EACA,WAAKsC,MAAL,GAAc,KAAKG,aAAL,CACZ,KAAKpD,UADO,EAEZ,KAAKC,cAAL,CAAoBsD,IAApB,CAAyB,IAAzB,CAFY,EAGZ,KAAKrD,YAAL,CAAkBqD,IAAlB,CAAuB,IAAvB,CAHY,CAAd;EAKD;;;qCAEcvC,YAAYD,YAAY;EACrC,UAAMyC,IAAI,GAAG;EAAExC,QAAAA,UAAU,EAAVA,UAAF;EAAcD,QAAAA,UAAU,EAAVA;EAAd,OAAb;EACA,UAAM0C,MAAM,GAAGC,IAAI,CAACC,IAAL,CAAU,CAACjD,IAAI,CAACC,GAAL,KAAa,KAAK0C,eAAnB,IAAsC,IAAhD,CAAf;;EACA,UAAI,CAAC,KAAKH,OAAL,CAAaO,MAAb,CAAL,EAA2B;EACzB,aAAKG,SAAL;EACA,aAAKV,OAAL,CAAaO,MAAb,IAAuB,CAACD,IAAD,CAAvB;EACD,OAHD,MAGO;EACL,aAAKN,OAAL,CAAaO,MAAb,EAAqBI,IAArB,CAA0BL,IAA1B;EACD;EACF;;;qCAEc;EACb,UAAI,KAAKb,MAAL,CAAYE,IAAhB,EAAsB;EACpB,YAAI,KAAKI,MAAL,IAAe,OAAO,KAAKA,MAAL,CAAY7B,OAAnB,KAA+B,UAAlD,EAA8D;EAC5D,eAAK6B,MAAL,CAAY7B,OAAZ;EACD;;EACD,aAAKkC,MAAL;EACD;EACF;;;kCAEW;EACV,UAAME,IAAI,GAAG,KAAKN,OAAL,CAAa,KAAKC,eAAL,EAAb,KAAwC,EAArD;EACA,UAAMW,YAAY,GAAG,KAAKC,SAAL,CAAeP,IAAf,EAAqB,YAArB,KAAsC,CAA3D;EACA,UAAMQ,YAAY,GAAG,KAAKD,SAAL,CAAeP,IAAf,EAAqB,YAArB,KAAsC,CAA3D;EACA,UAAMS,SAAS,GAAGD,YAAY,GAAGF,YAAf,IAA+B,CAAjD;EACA,UAAMI,SAAS,GAAGD,SAAS,GAAG,IAA9B;EACA,WAAKtB,MAAL,CAAYG,cAAZ,CAA2B;EACzBgB,QAAAA,YAAY,EAAZA,YADyB;EAEzBE,QAAAA,YAAY,EAAZA,YAFyB;EAGzBC,QAAAA,SAAS,EAATA,SAHyB;EAIzBC,QAAAA,SAAS,EAATA;EAJyB,OAA3B;EAMD;;;gCAESnB,QAAQoB,KAAK;EACrB,aAAOpB,MAAM,CAACqB,MAAP,CAAc,UAACC,GAAD,EAAMb,IAAN,EAAe;EAClC,eAAOa,GAAG,GAAGb,IAAI,CAACW,GAAD,CAAjB;EACD,OAFM,EAEJ,CAFI,CAAP;EAGD;;;gCAES;EACR,WAAKxB,MAAL,CAAYE,IAAZ,GAAmB,KAAnB;;EACA,UAAI,KAAKG,SAAT,EAAoB;EAClBsB,QAAAA,YAAY,CAAC,KAAKtB,SAAN,CAAZ;EACD;;EACD,UAAI,KAAKC,MAAL,IAAe,OAAO,KAAKA,MAAL,CAAY7B,OAAnB,KAA+B,UAAlD,EAA8D;EAC5D,aAAK6B,MAAL,CAAY7B,OAAZ;EACD;EACF;;;;;;;;;;;;"}