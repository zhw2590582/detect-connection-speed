{"version":3,"file":"detectConnectionSpeed-uncompiled.js","sources":["../node_modules/@babel/runtime/helpers/defineProperty.js","../node_modules/@babel/runtime/helpers/objectSpread.js","../node_modules/@babel/runtime/helpers/classCallCheck.js","../node_modules/@babel/runtime/helpers/createClass.js","../src/index.js"],"sourcesContent":["function _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nmodule.exports = _defineProperty;","var defineProperty = require(\"./defineProperty\");\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    var ownKeys = Object.keys(source);\n\n    if (typeof Object.getOwnPropertySymbols === 'function') {\n      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(source, sym).enumerable;\n      }));\n    }\n\n    ownKeys.forEach(function (key) {\n      defineProperty(target, key, source[key]);\n    });\n  }\n\n  return target;\n}\n\nmodule.exports = _objectSpread;","function _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nmodule.exports = _classCallCheck;","function _defineProperties(target, props) {\n  for (var i = 0; i < props.length; i++) {\n    var descriptor = props[i];\n    descriptor.enumerable = descriptor.enumerable || false;\n    descriptor.configurable = true;\n    if (\"value\" in descriptor) descriptor.writable = true;\n    Object.defineProperty(target, descriptor.key, descriptor);\n  }\n}\n\nfunction _createClass(Constructor, protoProps, staticProps) {\n  if (protoProps) _defineProperties(Constructor.prototype, protoProps);\n  if (staticProps) _defineProperties(Constructor, staticProps);\n  return Constructor;\n}\n\nmodule.exports = _createClass;","export default class DetectConnectionSpeed {\n  constructor(option) {\n    this.option = {\n      url: '',\n      loop: true,\n      time: 1000,\n      detectCallback: result => result,\n      ...option\n    };\n    this.transportFactory = this.getStreamFactory();\n    this.detect();\n  }\n\n  supportsXhrResponseType(type) {\n    try {\n      const tmpXhr = new XMLHttpRequest();\n      tmpXhr.responseType = type;\n      return tmpXhr.responseType === type;\n    } catch (e) {\n      return false;\n    }\n  }\n\n  getStreamFactory() {\n    if (\n      typeof Response !== 'undefined' &&\n      Object.prototype.hasOwnProperty.call(Response.prototype, 'body') &&\n      typeof Headers === 'function'\n    ) {\n      return this.fetchRequest;\n    }\n\n    const mozChunked = 'moz-chunked-arraybuffer';\n    if (this.supportsXhrResponseType(mozChunked)) {\n      return this.mozXhrRequest;\n    }\n\n    return this.xhrRequest;\n  }\n\n  detect() {\n    this.timer = null;\n    this.result = [];\n    this.detectStartTime = new Date().getTime();\n    this.requestUrl = this.option.url + '?time=' + this.detectStartTime;\n    this.transportFactory();\n  }\n\n  fetchRequest() {\n    if (typeof window.fetch !== 'function') {\n      throw new Error('fetch function is not supported in your environment');\n    }\n    this.reader = null;\n    return fetch(this.requestUrl).then(response => {\n      if (typeof response.body.getReader !== 'function') {\n        throw new Error(\n          'response.body.getReader function is not supported in your environment'\n        );\n      }\n      this.reader = response.body.getReader();\n      (function read() {\n        const readerStartTime = new Date().getTime();\n        this.reader\n          .read()\n          .then(({ done, value }) => {\n            if (done) {\n              this.summary();\n              if (this.option.loop) {\n                this.timer = setTimeout(\n                  this.detect.bind(this),\n                  this.option.time\n                );\n              }\n              return;\n            }\n            const readerEndTime = new Date().getTime();\n            this.calculate(\n              new Uint8Array(value),\n              readerEndTime - readerStartTime\n            );\n            read.call(this);\n          })\n          .catch(error => {\n            throw error;\n          });\n      }.call(this));\n    });\n  }\n\n  mozXhrRequest() {\n    this.xhr = new XMLHttpRequest();\n    this.xhr.open('GET', this.requestUrl, true);\n    this.xhr.responseType = 'moz-chunked-arraybuffer';\n\n    let readerStartTime = null;\n    const progress = () => {\n      const readerEndTime = new Date().getTime();\n      const streamTime = readerEndTime - readerStartTime;\n      this.calculate(new Uint8Array(this.xhr.response), streamTime);\n      readerStartTime = readerEndTime;\n    };\n\n    const readystatechange = () => {\n      if (this.xhr.readyState === 2) {\n        readerStartTime = new Date().getTime();\n      }\n    };\n\n    const loadend = () => {\n      this.summary();\n      if (this.option.loop) {\n        this.timer = setTimeout(this.detect.bind(this), this.option.time);\n      }\n    };\n\n    const error = () => {\n      throw error;\n    };\n\n    this.xhr.addEventListener('progress', progress);\n    this.xhr.addEventListener('readystatechange', readystatechange);\n    this.xhr.addEventListener('loadend', loadend);\n    this.xhr.addEventListener('error', error);\n    this.xhr.destroy = () => {\n      this.xhr.removeEventListener('progress', progress);\n      this.xhr.removeEventListener('readystatechange', readystatechange);\n      this.xhr.removeEventListener('loadend', loadend);\n      this.xhr.removeEventListener('error', error);\n    };\n\n    this.xhr.send();\n  }\n\n  calculate(uint8, streamTime) {\n    this.result.push({\n      streamSize: uint8.byteLength,\n      streamTime\n    });\n  }\n\n  summary() {\n    const detectEndTime = new Date().getTime();\n    const detectTime = detectEndTime - this.detectStartTime;\n    const downloadTime = this.resultSum('streamTime');\n    const waitingTime = detectTime - downloadTime;\n    const downloadSize = this.resultSum('streamSize');\n    const speedKbps = downloadSize / downloadTime;\n    const speedMbps = speedKbps / 1024;\n    this.option.detectCallback({\n      detectTime,\n      downloadTime,\n      downloadSize,\n      waitingTime,\n      speedKbps,\n      speedMbps\n    });\n  }\n\n  resultSum(key) {\n    return this.result.reduce((sum, item) => {\n      return sum + item[key];\n    }, 0);\n  }\n\n  destroy() {\n    this.option.loop = false;\n    if (this.timer) {\n      clearTimeout(this.timer);\n    }\n    if (this.reader && typeof this.reader.cancel === 'function') {\n      this.reader.cancel();\n    }\n    if (this.xhr && typeof this.xhr.abort === 'function') {\n      this.xhr.abort();\n      this.xhr.destroy();\n    }\n  }\n}\n"],"names":["DetectConnectionSpeed","option","url","loop","time","detectCallback","result","transportFactory","getStreamFactory","detect","type","tmpXhr","XMLHttpRequest","responseType","e","Response","Object","prototype","hasOwnProperty","call","Headers","fetchRequest","mozChunked","supportsXhrResponseType","mozXhrRequest","xhrRequest","timer","detectStartTime","Date","getTime","requestUrl","window","fetch","Error","reader","then","response","body","getReader","read","readerStartTime","done","value","summary","setTimeout","bind","readerEndTime","calculate","Uint8Array","error","xhr","open","progress","streamTime","readystatechange","readyState","loadend","addEventListener","destroy","removeEventListener","send","uint8","push","streamSize","byteLength","detectEndTime","detectTime","downloadTime","resultSum","waitingTime","downloadSize","speedKbps","speedMbps","key","reduce","sum","item","clearTimeout","cancel","abort"],"mappings":";;;;;;EAAA,SAAS,eAAe,CAAC,GAAG,EAAE,GAAG,EAAE,KAAK,EAAE;IACxC,IAAI,GAAG,IAAI,GAAG,EAAE;MACd,MAAM,CAAC,cAAc,CAAC,GAAG,EAAE,GAAG,EAAE;QAC9B,KAAK,EAAE,KAAK;QACZ,UAAU,EAAE,IAAI;QAChB,YAAY,EAAE,IAAI;QAClB,QAAQ,EAAE,IAAI;OACf,CAAC,CAAC;KACJ,MAAM;MACL,GAAG,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;KAClB;;IAED,OAAO,GAAG,CAAC;GACZ;;EAED,kBAAc,GAAG,eAAe;;ECbhC,SAAS,aAAa,CAAC,MAAM,EAAE;IAC7B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;MACzC,IAAI,MAAM,GAAG,SAAS,CAAC,CAAC,CAAC,IAAI,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;MACtD,IAAI,OAAO,GAAG,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;;MAElC,IAAI,OAAO,MAAM,CAAC,qBAAqB,KAAK,UAAU,EAAE;QACtD,OAAO,GAAG,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,qBAAqB,CAAC,MAAM,CAAC,CAAC,MAAM,CAAC,UAAU,GAAG,EAAE;UAClF,OAAO,MAAM,CAAC,wBAAwB,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,UAAU,CAAC;SAChE,CAAC,CAAC,CAAC;OACL;;MAED,OAAO,CAAC,OAAO,CAAC,UAAU,GAAG,EAAE;QAC7B,cAAc,CAAC,MAAM,EAAE,GAAG,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;OAC1C,CAAC,CAAC;KACJ;;IAED,OAAO,MAAM,CAAC;GACf;;EAED,gBAAc,GAAG,aAAa;;ECrB9B,SAAS,eAAe,CAAC,QAAQ,EAAE,WAAW,EAAE;IAC9C,IAAI,EAAE,QAAQ,YAAY,WAAW,CAAC,EAAE;MACtC,MAAM,IAAI,SAAS,CAAC,mCAAmC,CAAC,CAAC;KAC1D;GACF;;EAED,kBAAc,GAAG,eAAe;;ECNhC,SAAS,iBAAiB,CAAC,MAAM,EAAE,KAAK,EAAE;IACxC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,KAAK,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;MACrC,IAAI,UAAU,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;MAC1B,UAAU,CAAC,UAAU,GAAG,UAAU,CAAC,UAAU,IAAI,KAAK,CAAC;MACvD,UAAU,CAAC,YAAY,GAAG,IAAI,CAAC;MAC/B,IAAI,OAAO,IAAI,UAAU,EAAE,UAAU,CAAC,QAAQ,GAAG,IAAI,CAAC;MACtD,MAAM,CAAC,cAAc,CAAC,MAAM,EAAE,UAAU,CAAC,GAAG,EAAE,UAAU,CAAC,CAAC;KAC3D;GACF;;EAED,SAAS,YAAY,CAAC,WAAW,EAAE,UAAU,EAAE,WAAW,EAAE;IAC1D,IAAI,UAAU,EAAE,iBAAiB,CAAC,WAAW,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC;IACrE,IAAI,WAAW,EAAE,iBAAiB,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC;IAC7D,OAAO,WAAW,CAAC;GACpB;;EAED,eAAc,GAAG,YAAY;;MChBRA;;;EACnB,iCAAYC,MAAZ,EAAoB;EAAA;;EAClB,SAAKA,MAAL;EACEC,MAAAA,GAAG,EAAE,EADP;EAEEC,MAAAA,IAAI,EAAE,IAFR;EAGEC,MAAAA,IAAI,EAAE,IAHR;EAIEC,MAAAA,cAAc,EAAE,wBAAAC,MAAM;EAAA,eAAIA,MAAJ;EAAA;EAJxB,OAKKL,MALL;EAOA,SAAKM,gBAAL,GAAwB,KAAKC,gBAAL,EAAxB;EACA,SAAKC,MAAL;EACD;;;;8CAEuBC,MAAM;EAC5B,UAAI;EACF,YAAMC,MAAM,GAAG,IAAIC,cAAJ,EAAf;EACAD,QAAAA,MAAM,CAACE,YAAP,GAAsBH,IAAtB;EACA,eAAOC,MAAM,CAACE,YAAP,KAAwBH,IAA/B;EACD,OAJD,CAIE,OAAOI,CAAP,EAAU;EACV,eAAO,KAAP;EACD;EACF;;;yCAEkB;EACjB,UACE,OAAOC,QAAP,KAAoB,WAApB,IACAC,MAAM,CAACC,SAAP,CAAiBC,cAAjB,CAAgCC,IAAhC,CAAqCJ,QAAQ,CAACE,SAA9C,EAAyD,MAAzD,CADA,IAEA,OAAOG,OAAP,KAAmB,UAHrB,EAIE;EACA,eAAO,KAAKC,YAAZ;EACD;;EAED,UAAMC,UAAU,GAAG,yBAAnB;;EACA,UAAI,KAAKC,uBAAL,CAA6BD,UAA7B,CAAJ,EAA8C;EAC5C,eAAO,KAAKE,aAAZ;EACD;;EAED,aAAO,KAAKC,UAAZ;EACD;;;+BAEQ;EACP,WAAKC,KAAL,GAAa,IAAb;EACA,WAAKpB,MAAL,GAAc,EAAd;EACA,WAAKqB,eAAL,GAAuB,IAAIC,IAAJ,GAAWC,OAAX,EAAvB;EACA,WAAKC,UAAL,GAAkB,KAAK7B,MAAL,CAAYC,GAAZ,GAAkB,QAAlB,GAA6B,KAAKyB,eAApD;EACA,WAAKpB,gBAAL;EACD;;;qCAEc;EAAA;;EACb,UAAI,OAAOwB,MAAM,CAACC,KAAd,KAAwB,UAA5B,EAAwC;EACtC,cAAM,IAAIC,KAAJ,CAAU,qDAAV,CAAN;EACD;;EACD,WAAKC,MAAL,GAAc,IAAd;EACA,aAAOF,KAAK,CAAC,KAAKF,UAAN,CAAL,CAAuBK,IAAvB,CAA4B,UAAAC,QAAQ,EAAI;EAC7C,YAAI,OAAOA,QAAQ,CAACC,IAAT,CAAcC,SAArB,KAAmC,UAAvC,EAAmD;EACjD,gBAAM,IAAIL,KAAJ,CACJ,uEADI,CAAN;EAGD;;EACD,QAAA,KAAI,CAACC,MAAL,GAAcE,QAAQ,CAACC,IAAT,CAAcC,SAAd,EAAd;EACC,kBAASC,IAAT,GAAgB;EAAA;;EACf,cAAMC,eAAe,GAAG,IAAIZ,IAAJ,GAAWC,OAAX,EAAxB;EACA,eAAKK,MAAL,CACGK,IADH,GAEGJ,IAFH,CAEQ,gBAAqB;EAAA,gBAAlBM,IAAkB,QAAlBA,IAAkB;EAAA,gBAAZC,KAAY,QAAZA,KAAY;;EACzB,gBAAID,IAAJ,EAAU;EACR,cAAA,MAAI,CAACE,OAAL;;EACA,kBAAI,MAAI,CAAC1C,MAAL,CAAYE,IAAhB,EAAsB;EACpB,gBAAA,MAAI,CAACuB,KAAL,GAAakB,UAAU,CACrB,MAAI,CAACnC,MAAL,CAAYoC,IAAZ,CAAiB,MAAjB,CADqB,EAErB,MAAI,CAAC5C,MAAL,CAAYG,IAFS,CAAvB;EAID;;EACD;EACD;;EACD,gBAAM0C,aAAa,GAAG,IAAIlB,IAAJ,GAAWC,OAAX,EAAtB;;EACA,YAAA,MAAI,CAACkB,SAAL,CACE,IAAIC,UAAJ,CAAeN,KAAf,CADF,EAEEI,aAAa,GAAGN,eAFlB;;EAIAD,YAAAA,IAAI,CAACpB,IAAL,CAAU,MAAV;EACD,WAnBH,WAoBS,UAAA8B,KAAK,EAAI;EACd,kBAAMA,KAAN;EACD,WAtBH;EAuBD,SAzBA,EAyBC9B,IAzBD,CAyBM,KAzBN,CAAD;EA0BD,OAjCM,CAAP;EAkCD;;;sCAEe;EAAA;;EACd,WAAK+B,GAAL,GAAW,IAAItC,cAAJ,EAAX;EACA,WAAKsC,GAAL,CAASC,IAAT,CAAc,KAAd,EAAqB,KAAKrB,UAA1B,EAAsC,IAAtC;EACA,WAAKoB,GAAL,CAASrC,YAAT,GAAwB,yBAAxB;EAEA,UAAI2B,eAAe,GAAG,IAAtB;;EACA,UAAMY,QAAQ,GAAG,SAAXA,QAAW,GAAM;EACrB,YAAMN,aAAa,GAAG,IAAIlB,IAAJ,GAAWC,OAAX,EAAtB;EACA,YAAMwB,UAAU,GAAGP,aAAa,GAAGN,eAAnC;;EACA,QAAA,MAAI,CAACO,SAAL,CAAe,IAAIC,UAAJ,CAAe,MAAI,CAACE,GAAL,CAASd,QAAxB,CAAf,EAAkDiB,UAAlD;;EACAb,QAAAA,eAAe,GAAGM,aAAlB;EACD,OALD;;EAOA,UAAMQ,gBAAgB,GAAG,SAAnBA,gBAAmB,GAAM;EAC7B,YAAI,MAAI,CAACJ,GAAL,CAASK,UAAT,KAAwB,CAA5B,EAA+B;EAC7Bf,UAAAA,eAAe,GAAG,IAAIZ,IAAJ,GAAWC,OAAX,EAAlB;EACD;EACF,OAJD;;EAMA,UAAM2B,OAAO,GAAG,SAAVA,OAAU,GAAM;EACpB,QAAA,MAAI,CAACb,OAAL;;EACA,YAAI,MAAI,CAAC1C,MAAL,CAAYE,IAAhB,EAAsB;EACpB,UAAA,MAAI,CAACuB,KAAL,GAAakB,UAAU,CAAC,MAAI,CAACnC,MAAL,CAAYoC,IAAZ,CAAiB,MAAjB,CAAD,EAAyB,MAAI,CAAC5C,MAAL,CAAYG,IAArC,CAAvB;EACD;EACF,OALD;;EAOA,UAAM6C,KAAK,GAAG,SAARA,KAAQ,GAAM;EAClB,cAAMA,KAAN;EACD,OAFD;;EAIA,WAAKC,GAAL,CAASO,gBAAT,CAA0B,UAA1B,EAAsCL,QAAtC;EACA,WAAKF,GAAL,CAASO,gBAAT,CAA0B,kBAA1B,EAA8CH,gBAA9C;EACA,WAAKJ,GAAL,CAASO,gBAAT,CAA0B,SAA1B,EAAqCD,OAArC;EACA,WAAKN,GAAL,CAASO,gBAAT,CAA0B,OAA1B,EAAmCR,KAAnC;;EACA,WAAKC,GAAL,CAASQ,OAAT,GAAmB,YAAM;EACvB,QAAA,MAAI,CAACR,GAAL,CAASS,mBAAT,CAA6B,UAA7B,EAAyCP,QAAzC;;EACA,QAAA,MAAI,CAACF,GAAL,CAASS,mBAAT,CAA6B,kBAA7B,EAAiDL,gBAAjD;;EACA,QAAA,MAAI,CAACJ,GAAL,CAASS,mBAAT,CAA6B,SAA7B,EAAwCH,OAAxC;;EACA,QAAA,MAAI,CAACN,GAAL,CAASS,mBAAT,CAA6B,OAA7B,EAAsCV,KAAtC;EACD,OALD;;EAOA,WAAKC,GAAL,CAASU,IAAT;EACD;;;gCAESC,OAAOR,YAAY;EAC3B,WAAK/C,MAAL,CAAYwD,IAAZ,CAAiB;EACfC,QAAAA,UAAU,EAAEF,KAAK,CAACG,UADH;EAEfX,QAAAA,UAAU,EAAVA;EAFe,OAAjB;EAID;;;gCAES;EACR,UAAMY,aAAa,GAAG,IAAIrC,IAAJ,GAAWC,OAAX,EAAtB;EACA,UAAMqC,UAAU,GAAGD,aAAa,GAAG,KAAKtC,eAAxC;EACA,UAAMwC,YAAY,GAAG,KAAKC,SAAL,CAAe,YAAf,CAArB;EACA,UAAMC,WAAW,GAAGH,UAAU,GAAGC,YAAjC;EACA,UAAMG,YAAY,GAAG,KAAKF,SAAL,CAAe,YAAf,CAArB;EACA,UAAMG,SAAS,GAAGD,YAAY,GAAGH,YAAjC;EACA,UAAMK,SAAS,GAAGD,SAAS,GAAG,IAA9B;EACA,WAAKtE,MAAL,CAAYI,cAAZ,CAA2B;EACzB6D,QAAAA,UAAU,EAAVA,UADyB;EAEzBC,QAAAA,YAAY,EAAZA,YAFyB;EAGzBG,QAAAA,YAAY,EAAZA,YAHyB;EAIzBD,QAAAA,WAAW,EAAXA,WAJyB;EAKzBE,QAAAA,SAAS,EAATA,SALyB;EAMzBC,QAAAA,SAAS,EAATA;EANyB,OAA3B;EAQD;;;gCAESC,KAAK;EACb,aAAO,KAAKnE,MAAL,CAAYoE,MAAZ,CAAmB,UAACC,GAAD,EAAMC,IAAN,EAAe;EACvC,eAAOD,GAAG,GAAGC,IAAI,CAACH,GAAD,CAAjB;EACD,OAFM,EAEJ,CAFI,CAAP;EAGD;;;gCAES;EACR,WAAKxE,MAAL,CAAYE,IAAZ,GAAmB,KAAnB;;EACA,UAAI,KAAKuB,KAAT,EAAgB;EACdmD,QAAAA,YAAY,CAAC,KAAKnD,KAAN,CAAZ;EACD;;EACD,UAAI,KAAKQ,MAAL,IAAe,OAAO,KAAKA,MAAL,CAAY4C,MAAnB,KAA8B,UAAjD,EAA6D;EAC3D,aAAK5C,MAAL,CAAY4C,MAAZ;EACD;;EACD,UAAI,KAAK5B,GAAL,IAAY,OAAO,KAAKA,GAAL,CAAS6B,KAAhB,KAA0B,UAA1C,EAAsD;EACpD,aAAK7B,GAAL,CAAS6B,KAAT;EACA,aAAK7B,GAAL,CAASQ,OAAT;EACD;EACF;;;;;;;;;;;;"}